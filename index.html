```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI任我行 掌控未来</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // 科技感的深黑和电光蓝
                        'black-deep': '#0A0A1F', // 深夜蓝/黑
                        'gray-dark': '#1A2035', // 组件背景色
                        'accent': '#00BFFF',    // 电光蓝 (Sky Blue)
                        'accent-dark': '#009ACD',
                        'input-bg': '#2B3750', // 专门为输入框设置的深蓝色背景
                    },
                    boxShadow: {
                        // 强大的霓虹发光效果，让按钮更醒目
                        'neon': '0 0 10px #00BFFF, 0 0 20px rgba(0, 191, 255, 0.6)',
                        'neon-sm': '0 0 5px #00BFFF',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0A0A1F; /* 深色背景 */
            color: #E5E7EB; /* 浅灰文本 */
            min-height: 100vh;
        }
        .container-main {
            max-width: 1100px; /* 增加宽度 */
            margin: auto;
        }
        /* 霓虹文本效果 */
        .text-neon {
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.8), 0 0 10px rgba(0, 191, 255, 0.5);
        }
        
        /* 1. 按钮边框美化 - 使用渐变和阴影的科技感边框 */
        .btn-neon {
            /* 基础样式 */
            @apply px-8 py-3 rounded-xl font-bold transition duration-300 uppercase tracking-wider relative overflow-hidden;
            /* 按钮核心背景和文字颜色 */
            @apply bg-gray-dark text-accent;
            /* 边框和阴影 */
            box-shadow: 0 0 8px rgba(0, 191, 255, 0.5);
            /* 轻微倾斜增加科技感 */
            transform: skew(-5deg); 
            z-index: 1;
        }
        /* 按钮边框的伪元素实现 */
        .btn-neon::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* 边框渐变效果 */
            background: linear-gradient(45deg, #00BFFF, #8A2BE2); 
            padding: 2px; /* 边框厚度 */
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            border-radius: 12px;
        }

        .btn-neon:hover:not(:disabled) {
            @apply bg-accent text-black-deep shadow-neon;
            transform: skew(-5deg) translateY(-2px);
            z-index: 1;
        }
        .btn-neon:hover::before {
             /* 悬停时边框消失，让背景填充 */
            padding: 0;
            opacity: 0;
        }

        .btn-neon:disabled {
            @apply opacity-40 cursor-not-allowed text-gray-400 bg-gray-800;
            box-shadow: none;
            transform: skew(-5deg);
        }
        /* 去除按钮倾斜效果的通用样式 */
        .no-skew {
            transform: none !important;
        }
        
        /* 2 & 3. 输入框和信息录入框美化 - 修复文字可见性 */
        .input-dark {
            /* 确保文字清晰可见：亮白文字 */
            @apply text-white; 
            /* 使用专门的深蓝色背景，比组件背景更深，对比度更高 */
            @apply bg-input-bg border-2 border-accent-dark rounded-xl p-3; 
            /* 聚焦时的霓虹边框效果 */
            @apply focus:ring-1 focus:ring-accent focus:border-accent; 
            /* 内部阴影和占位符美化 */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            @apply transition duration-200 placeholder-gray-400;
        }

        /* 主题卡片 */
        .topic-card {
            @apply bg-gray-dark rounded-xl shadow-lg border border-gray-800 transition duration-300 cursor-pointer;
            transition: all 0.2s ease-in-out;
        }
        .topic-card:hover {
            @apply border-l-4 border-accent shadow-neon-sm;
            transform: translateY(-3px) scale(1.005);
        }
        /* 模态框内容美化 */
        #modal-content {
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.3); /* 更强的模态框边缘光 */
        }
    </style>
</head>
<body class="font-sans">

    <!-- 导航栏 -->
    <nav class="sticky top-0 z-10 bg-black-deep bg-opacity-90 backdrop-blur-sm shadow-2xl border-b border-accent-dark">
        <div class="container-main mx-auto px-4 py-4 flex justify-between items-center">
            <a href="javascript:void(0)" onclick="navigate('list')" class="text-3xl font-extrabold text-accent text-neon tracking-widest">AI任我行</a>
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <span id="user-level-display" class="text-sm font-medium text-gray-400 block">Lv.0 | 游客</span>
                    <span id="username-display" class="text-lg font-bold text-white text-neon block">UserID...</span>
                </div>
                <button id="show-profile-btn" class="text-accent hover:text-white transition duration-150 p-2 rounded-full border border-accent hover:shadow-neon-sm no-skew">
                    <!-- Lucide: User Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <main class="container-main mx-auto p-4 sm:p-6">

        <!-- 社区核心区 - Hero Section -->
        <section id="hero" class="py-20 text-center mb-16 rounded-3xl bg-gray-dark border-2 border-accent-dark shadow-neon-sm">
            <h1 class="text-5xl sm:text-7xl font-extrabold mb-4 text-white">
                <span class="text-accent text-neon">AI 任我行</span>
            </h1>
            <!-- UPDATED SLOGAN -->
            <h2 class="text-xl sm:text-3xl font-light text-gray-300 mt-2">
                从今天起，AI不再是别人家的魔法！
            </h2>
            <p class="text-lg text-gray-500 mt-4">
                乐山疯子 · 零门槛 · 极致实践
            </p>
            <div class="mt-10">
                <a href="#topics-list-section" class="btn-neon no-skew">
                    <span class="no-skew block">开始探索社区</span>
                </a>
            </div>
        </section>
        
        <!-- 加载状态 -->
        <div id="loading" class="text-center p-12 text-gray-500">
            <svg class="animate-spin h-8 w-8 text-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-accent text-neon">正在连接 AI 矩阵核心...</p>
        </div>

        <!-- 讨论区/SPA 主容器 -->
        <section id="topics-list-section" class="pt-8 min-h-[500px]">
            <!-- 动态内容 (主题列表 或 讨论详情) 将在此处渲染 -->
        </section>

        <!-- 个人资料/注册/等级模态框 (隐藏) -->
        <div id="profile-modal" class="fixed inset-0 bg-black-deep bg-opacity-90 z-20 hidden flex justify-center items-center p-4" onclick="if(event.target.id === 'profile-modal') closeModal()">
            <div id="modal-content" class="bg-gray-dark p-8 rounded-2xl w-full max-w-lg border-2 border-accent-dark">
                <h3 class="text-2xl font-bold text-accent mb-6 border-b border-gray-700 pb-3" id="modal-title">社区身份信息</h3>
                <div id="modal-body">
                    <!-- 动态内容：注册表单或档案信息 -->
                </div>
                <div class="mt-8 text-right">
                    <button onclick="closeModal()" class="btn-neon no-skew">
                         <span class="no-skew block">关闭</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 消息提示框 (代替 alert()) -->
        <div id="message-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transition-opacity duration-300 hidden z-50"></div>
    </main>

    <!-- 底部信息 -->
    <footer class="mt-20 border-t border-gray-800 py-10">
        <div class="container-main mx-auto px-4 text-center">
            <h3 class="text-xl font-bold text-accent text-neon mb-4">极速连接</h3>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-12 mb-8">
                <!-- 电话信息 -->
                <div class="flex items-center space-x-3 text-gray-300">
                    <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-3.28a1 1 0 01-.948-.684l-1.498-4.493a1 1 0 01.502-1.21l2.257-1.13a11.042 11.042 0 00-5.516-5.516l-1.13 2.257a1 1 0 01-1.21.502l-4.493-1.498A1 1 0 015 5.28V5z"></path></svg>
                    <span class="font-mono text-lg text-accent-dark">+86 186-0806-5128</span>
                </div>
                <!-- 地址信息 -->
                <div class="flex items-center space-x-3 text-gray-300 text-left">
                    <svg class="w-6 h-6 text-accent flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="max-w-xs text-gray-400">中国 四川省 乐山市 万兴城四栋五区3楼</span>
                </div>
            </div>
            <p class="text-sm text-gray-700 mt-6">&copy; 2024 AI任我行. All rights reserved by 乐山疯子.</p>
        </div>
    </footer>

    <!-- 引入 Firebase SDKs 和核心逻辑 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            query, 
            orderBy,
            serverTimestamp,
            getDoc,
            doc,
            setDoc,
            updateDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 全局变量和配置 ---
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let userProfile = null; // 存储用户档案 (昵称, 地区, 电话, 等级, XP)
        
        // 应用状态：name: 'list' | 'discussion'
        let currentView = { name: 'list', topicId: null };

        // Firestore 集合名称
        const TOPICS_COLLECTION = 'topics';
        const POSTS_COLLECTION = 'posts';
        const PROFILES_COLLECTION = 'profiles';
        
        // Canvas环境提供的全局变量 (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-aiwoxing-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI 元素
        const loadingEl = document.getElementById('loading');
        const appContainerEl = document.getElementById('topics-list-section'); // SPA 根容器
        const messageBoxEl = document.getElementById('message-box');
        const usernameDisplayEl = document.getElementById('username-display');
        const userLevelDisplayEl = document.getElementById('user-level-display');
        const profileModalEl = document.getElementById('profile-modal');
        const modalBodyEl = document.getElementById('modal-body');
        const modalTitleEl = document.getElementById('modal-title');

        // --- 辅助函数：Firestore路径和工具 ---

        function getPublicCollectionPath(collectionName) {
            // 所有主题和帖子都存储为公共数据
            return `/artifacts/${appId}/public/data/${collectionName}`;
        }

        function getPrivateDocRef(collectionName, docId) {
            // 用户的私有档案路径
            return doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, docId);
        }
        
        function getTopicsCollectionRef() {
            return collection(db, getPublicCollectionPath(TOPICS_COLLECTION));
        }

        function getTopicDocRef(topicId) {
            return doc(db, getPublicCollectionPath(TOPICS_COLLECTION), topicId);
        }

        function getPostsCollectionRef(topicId) {
            // 帖子的集合路径：/artifacts/{appId}/public/data/topics/{topicId}/posts
            return collection(db, getPublicCollectionPath(TOPICS_COLLECTION), topicId, POSTS_COLLECTION);
        }

        // 经验值计算函数
        function getLevel(xp) {
            if (xp < 100) return 1;
            // 采用公式: 100 * Level^2 ≈ XP
            return Math.floor(Math.sqrt(xp / 100)) + 1;
        }

        function getXPRequiredForNextLevel(level) {
            return 100 * Math.pow(level, 2);
        }

        // 统一的消息显示（代替 alert()）
        function showMessage(text, isError = false) {
            messageBoxEl.textContent = text;
            messageBoxEl.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl ${isError ? 'bg-red-600' : 'bg-green-600'} text-white z-50 transition-opacity duration-300`;
            messageBoxEl.style.display = 'block';
            messageBoxEl.style.opacity = '1';
            
            setTimeout(() => {
                messageBoxEl.style.opacity = '0';
                setTimeout(() => {
                    messageBoxEl.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function closeModal() {
            profileModalEl.classList.add('hidden');
        }
        
        // --- 档案管理和等级系统 (逻辑不变) ---
        
        function setupProfileListener() {
            if (!db || !userId) return;

            // 监听用户档案，确保实时更新
            onSnapshot(getPrivateDocRef(PROFILES_COLLECTION, userId), (docSnap) => {
                const oldLevel = userProfile ? getLevel(userProfile.xp) : 0;

                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    if (!userProfile.xp) userProfile.xp = 0;
                    if (!userProfile.level) userProfile.level = 1;
                    
                    const newLevel = getLevel(userProfile.xp);

                    if (newLevel > oldLevel && oldLevel > 0) {
                         showMessage(`恭喜! 您升级到了 Lv.${newLevel} ${getLevelTitle(newLevel)}!`, false);
                    }

                } else {
                    userProfile = {
                        username: 'UserID...',
                        region: '',
                        phone: '',
                        xp: 0,
                        level: 1,
                        isRegistered: false
                    };
                    if (!userProfile.isRegistered) {
                        showRegistrationModal();
                    }
                }
                updateUIProfile();

            }, (error) => {
                console.error("Error fetching profile: ", error);
                showMessage(`加载用户档案失败: ${error.message}`, true);
            });
        }
        
        function getLevelTitle(level) {
            if (level >= 10) return 'AI大师';
            if (level >= 7) return '矩阵建造者';
            if (level >= 4) return '代码探索家';
            return 'AI学习者';
        }

        function updateUIProfile() {
            if (!userProfile) return;
            
            const level = getLevel(userProfile.xp);
            const title = getLevelTitle(level);

            usernameDisplayEl.textContent = userProfile.username || 'UserID...';
            userLevelDisplayEl.textContent = `Lv.${level} | ${title}`;
        }

        async function grantXP(xpAmount) {
            if (!db || !userId || !userProfile) return;

            const profileRef = getPrivateDocRef(PROFILES_COLLECTION, userId);
            try {
                await updateDoc(profileRef, {
                    xp: increment(xpAmount)
                });
            } catch (error) {
                console.error("Error granting XP:", error);
            }
        }
        
        // --- 模态框和注册 (美化输入框并保持功能不变) ---
        
        function showRegistrationModal() {
            if (userProfile && userProfile.isRegistered) return; 

            modalTitleEl.textContent = "创建您的 AI 社区昵称 (必填)";
            profileModalEl.classList.remove('hidden');

            modalBodyEl.innerHTML = `
                <form id="registration-form" class="space-y-4">
                    <div>
                        <label for="reg-username" class="block text-sm font-medium text-gray-300">社区昵称 (必填)</label>
                        <input type="text" id="reg-username" required class="mt-1 block w-full input-dark" placeholder="例如: 乐山疯子">
                    </div>
                    <div>
                        <label for="reg-region" class="block text-sm font-medium text-gray-300">所在城市/地区 (必填)</label>
                        <input type="text" id="reg-region" required class="mt-1 block w-full input-dark" placeholder="例如: 四川 成都">
                    </div>
                    <div>
                        <label for="reg-phone" class="block text-sm font-medium text-gray-300">联系电话 (选填)</label>
                        <input type="tel" id="reg-phone" class="mt-1 block w-full input-dark" placeholder="用于紧急联系">
                    </div>
                    <button type="submit" class="w-full btn-neon mt-6" id="reg-submit-btn">
                        <span class="no-skew block">确定并进入社区</span>
                    </button>
                </form>
            `;

            document.getElementById('registration-form').onsubmit = async (e) => {
                e.preventDefault();
                const username = document.getElementById('reg-username').value.trim();
                const region = document.getElementById('reg-region').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();

                if (!username || !region) return showMessage('昵称和地区必填', true);

                const submitBtn = document.getElementById('reg-submit-btn');
                submitBtn.disabled = true;
                submitBtn.querySelector('span').textContent = '注册中...';

                try {
                    await setDoc(getPrivateDocRef(PROFILES_COLLECTION, userId), {
                        username,
                        region,
                        phone,
                        xp: 0,
                        level: 1,
                        isRegistered: true,
                        createdAt: serverTimestamp()
                    });
                    closeModal();
                    showMessage('档案创建成功！欢迎加入 AI任我行。');
                } catch (error) {
                    console.error("Registration error:", error);
                    showMessage(`注册失败: ${error.message}`, true);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.querySelector('span').textContent = '确定并进入社区';
                }
            };
        }
        
        function showProfileModal() {
            if (!userProfile || !userProfile.isRegistered) {
                return showRegistrationModal(); 
            }

            modalTitleEl.textContent = "我的 AI 社区档案";
            profileModalEl.classList.remove('hidden');

            const level = getLevel(userProfile.xp);
            const xpNeeded = getXPRequiredForNextLevel(level);
            const xpRequiredForCurrent = getXPRequiredForNextLevel(level - 1);
            const xpProgress = userProfile.xp - xpRequiredForCurrent;
            const xpTotalNeeded = xpNeeded - xpRequiredForCurrent;
            const xpBarWidth = (xpTotalNeeded > 0) ? (xpProgress / xpTotalNeeded) * 100 : 100;

            const title = getLevelTitle(level);

            modalBodyEl.innerHTML = `
                <div class="space-y-4 text-gray-300">
                    <p><strong>社区昵称:</strong> <span class="text-accent">${userProfile.username}</span></p>
                    <p><strong>当前 ID:</strong> <span class="text-xs font-mono text-gray-500 break-all">${userId}</span></p>
                    <p><strong>所在地区:</strong> ${userProfile.region || '未设置'}</p>
                    <p><strong>联系电话:</strong> ${userProfile.phone || '未设置'}</p>
                    <div class="bg-gray-700 p-4 rounded-lg border border-accent-dark">
                        <h4 class="font-bold text-lg text-accent border-b border-gray-600 pb-2 mb-2">等级成就</h4>
                        <p class="text-xl font-extrabold mb-1">Lv.${level} | ${title}</p>
                        <p class="text-sm">总经验值 (XP): ${userProfile.xp}</p>
                        <p class="text-sm mt-1">下一个等级 (${level + 1}) 需要 ${xpNeeded} XP</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                            <div class="bg-accent h-2.5 rounded-full shadow-neon-sm transition-all duration-500" style="width: ${Math.min(xpBarWidth, 100)}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 绑定 Profile 按钮事件
        document.getElementById('show-profile-btn').onclick = showProfileModal;


        // --- 媒体渲染辅助函数 (NEW) ---
        function renderMedia(topic) {
            let mediaHtml = '';
            
            // 1. Image Rendering
            if (topic.imageUrl) {
                mediaHtml += `
                    <div class="mt-3 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                        <img src="${topic.imageUrl}" alt="主题图片" class="w-full max-h-80 object-cover" 
                             onerror="this.onerror=null;this.style.display='none';this.parentElement.style.display='none';">
                    </div>
                `;
            }

            // 2. Video Rendering (Supports embed links or general video URLs)
            if (topic.videoUrl) {
                const isEmbed = topic.videoUrl.includes('youtube.com/embed') || topic.videoUrl.includes('vimeo.com/video');
                
                if (isEmbed) {
                     mediaHtml += `
                        <div class="mt-3 aspect-video rounded-xl overflow-hidden shadow-lg border border-gray-700">
                            <iframe src="${topic.videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen
                                class="w-full h-full"></iframe>
                        </div>
                    `;
                } else {
                     // Fallback for general video URLs
                     mediaHtml += `
                        <div class="mt-3 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                            <video controls src="${topic.videoUrl}" class="w-full max-h-80 bg-black"></video>
                        </div>
                     `;
                }
            }

            return mediaHtml;
        }


        // --- 视图：主题列表 (Topic List) ---

        function renderTopicList() {
            const container = document.createElement('div');
            container.className = 'space-y-8';

            // 1. 发布新主题表单
            container.appendChild(createNewTopicForm());

            // 2. 主题列表容器
            const listHeader = document.createElement('h2');
            listHeader.className = 'text-3xl font-bold text-accent text-neon pt-4 border-t border-gray-800 mt-12 mb-4 tracking-wider';
            listHeader.textContent = '社区最新讨论';
            container.appendChild(listHeader);

            const topicListContainer = document.createElement('div');
            topicListContainer.id = 'topic-list';
            topicListContainer.className = 'divide-y divide-gray-800';
            container.appendChild(topicListContainer);

            // 实时监听主题变化：按最新活动时间 (lastRepliedAt) 排序
            onSnapshot(query(getTopicsCollectionRef(), orderBy('lastRepliedAt', 'desc')), (snapshot) => {
                topicListContainer.innerHTML = ''; // 清空列表
                
                if (snapshot.empty) {
                    topicListContainer.innerHTML = '<p class="p-6 text-center text-gray-500 bg-gray-dark rounded-xl">暂无主题，快来发布第一个吧！</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const topic = doc.data();
                    const topicId = doc.id;
                    const item = document.createElement('div');
                    
                    const date = topic.lastRepliedAt && topic.lastRepliedAt.toDate 
                                 ? topic.lastRepliedAt.toDate()
                                 : (topic.createdAt && topic.createdAt.toDate ? topic.createdAt.toDate() : new Date());

                    item.className = 'topic-card p-4 sm:p-6';
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-semibold text-white leading-tight">${topic.title}</h3>
                            <span class="text-xs text-gray-500 min-w-max ml-4 mt-1">${date.toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-400 text-sm mt-1 line-clamp-2">${topic.content}</p>
                        ${renderMedia(topic)} <!-- 渲染图片/视频 -->
                        <div class="text-xs mt-3 flex justify-between items-center">
                            <span class="text-accent font-medium text-sm">发起人: ${topic.authorUsername || '匿名用户'}</span>
                            <div class="flex items-center space-x-3 text-gray-500">
                                <span class="text-sm">回复数: <span class="font-bold text-white">${topic.replyCount || 0}</span></span>
                                <!-- 使用 btn-neon 样式，但尺寸缩小，去除倾斜 -->
                                <button class="btn-neon px-4 py-1 text-sm no-skew" onclick="navigate('discussion', '${topicId}'); event.stopPropagation();">
                                    <span class="no-skew block">进入讨论</span>
                                </button>
                            </div>
                        </div>
                    `;
                    // 确保点击整个卡片也能进入讨论，但点击按钮时事件不重复
                    item.onclick = () => navigate('discussion', topicId);
                    topicListContainer.appendChild(item);
                });
            }, (error) => {
                console.error("Error fetching topics: ", error);
                topicListContainer.innerHTML = `<p class="p-6 text-center text-red-500">加载主题失败: ${error.message}</p>`;
            });

            return container;
        }

        function createNewTopicForm() {
            const formContainer = document.createElement('div');
            formContainer.className = 'bg-gray-dark p-6 rounded-xl shadow-2xl border-2 border-accent-dark';
            
            formContainer.innerHTML = `
                <h3 class="text-2xl font-bold text-accent mb-4 border-b border-gray-700 pb-2">提交新的挑战/问题 (支持图片/视频分享)</h3>
                <form id="new-topic-form" class="space-y-4">
                    <div>
                        <label for="topic-title" class="block text-sm font-medium text-gray-300">主题标题 (必填)</label>
                        <input type="text" id="topic-title" required class="mt-1 block w-full input-dark" placeholder="例如: 如何用 Gemini 优化 React 性能">
                    </div>
                    <div>
                        <label for="topic-content" class="block text-sm font-medium text-gray-300">详细描述 (必填)</label>
                        <textarea id="topic-content" rows="4" required class="mt-1 block w-full input-dark resize-none" placeholder="详细描述您的问题、想法或挑战..."></textarea>
                    </div>

                    <!-- New Media Fields -->
                    <div>
                        <label for="image-url" class="block text-sm font-medium text-gray-300">图片 URL (可选)</label>
                        <input type="url" id="image-url" class="mt-1 block w-full input-dark" placeholder="粘贴图片链接，如: https://placehold.co/600x400">
                    </div>
                    <div>
                        <label for="video-url" class="block text-sm font-medium text-gray-300">视频 URL (可选)</label>
                        <input type="url" id="video-url" class="mt-1 block w-full input-dark" placeholder="粘贴视频嵌入链接 (如 YouTube embed)">
                    </div>
                    
                    <button type="submit" id="submit-topic-btn" class="w-full btn-neon mt-6">
                        <span class="no-skew block">立即发布主题</span>
                    </button>
                </form>
            `;

            formContainer.querySelector('#new-topic-form').onsubmit = async (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.isRegistered) return showRegistrationModal();

                const title = formContainer.querySelector('#topic-title').value.trim();
                const content = formContainer.querySelector('#topic-content').value.trim();
                const imageUrl = formContainer.querySelector('#image-url').value.trim(); // NEW
                const videoUrl = formContainer.querySelector('#video-url').value.trim(); // NEW

                const submitBtn = formContainer.querySelector('#submit-topic-btn');

                if (!title || !content) return showMessage('标题和内容不能为空', true);
                
                submitBtn.disabled = true;
                submitBtn.querySelector('span').textContent = '正在发布...';

                try {
                    await addDoc(getTopicsCollectionRef(), {
                        title,
                        content,
                        imageUrl: imageUrl || null, // 保存图片 URL
                        videoUrl: videoUrl || null, // 保存视频 URL
                        authorId: userId,
                        authorUsername: userProfile.username,
                        createdAt: serverTimestamp(),
                        lastRepliedAt: serverTimestamp(), 
                        replyCount: 0
                    });

                    // 奖励经验值
                    const xpGained = 50 + Math.ceil(title.length / 5) + Math.ceil(content.length / 10); 
                    await grantXP(xpGained);
                    
                    formContainer.querySelector('#topic-title').value = '';
                    formContainer.querySelector('#topic-content').value = '';
                    formContainer.querySelector('#image-url').value = ''; // 清空新字段
                    formContainer.querySelector('#video-url').value = ''; // 清空新字段

                    showMessage(`主题发布成功！获得 ${xpGained} XP。`);
                } catch (error) {
                    console.error("Error adding topic: ", error);
                    showMessage(`发布主题失败: ${error.message}`, true);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.querySelector('span').textContent = '立即发布主题';
                }
            };

            return formContainer;
        }

        // --- 视图：讨论详情和回复 (Discussion Detail + Replies) ---

        function renderDiscussion(topicId) {
            const container = document.createElement('div');
            container.className = 'space-y-6';

            // 返回按钮
            const backButton = document.createElement('button');
            backButton.className = 'btn-neon px-5 py-2 text-base no-skew flex items-center mb-8';
            backButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 no-skew" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="no-skew block">返回主题列表</span>
            `;
            backButton.onclick = () => navigate('list');
            container.appendChild(backButton);

            // 主题详情容器
            const topicDetail = document.createElement('div');
            topicDetail.className = 'bg-gray-dark p-6 rounded-xl shadow-2xl border-l-4 border-accent';
            topicDetail.innerHTML = `<h1 class="text-2xl font-bold text-white">加载主题信息...</h1>`;
            container.appendChild(topicDetail);

            // 帖子列表容器
            const postListHeader = document.createElement('h2');
            postListHeader.className = 'text-2xl font-bold text-accent pt-4 border-t border-gray-800 mt-8 mb-4 tracking-wide';
            postListHeader.textContent = '社区解答与回复';
            container.appendChild(postListHeader);

            const postListContainer = document.createElement('div');
            postListContainer.id = 'post-list';
            postListContainer.className = 'space-y-4 mt-4';
            container.appendChild(postListContainer);
            
            // 新帖子/回复表单
            container.appendChild(createNewPostForm(topicId));

            // 异步获取主题详情
            getTopicDocDetail(topicId, topicDetail);

            // 实时监听帖子变化 (按时间升序)
            onSnapshot(query(getPostsCollectionRef(topicId), orderBy('createdAt', 'asc')), (snapshot) => {
                postListContainer.innerHTML = ''; // 清空列表
                
                if (snapshot.empty) {
                    postListContainer.innerHTML = '<p class="p-6 text-center text-gray-500 bg-gray-dark rounded-lg shadow-sm border border-gray-700">暂无回复，快来发表您的解答吧！</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const post = doc.data();
                    const date = post.createdAt && post.createdAt.toDate ? post.createdAt.toDate() : new Date();
                    const isAuthor = post.authorId === userId;

                    const postItem = document.createElement('div');
                    postItem.className = `bg-gray-dark p-4 rounded-lg shadow-md border border-gray-700 border-l-4 ${isAuthor ? 'border-accent' : 'border-gray-500'} hover:border-accent transition duration-150`;
                    postItem.innerHTML = `
                        <p class="text-gray-300 text-base leading-relaxed">${post.content}</p>
                        <div class="mt-3 text-xs text-gray-500 flex justify-between border-t border-gray-700 pt-2">
                            <span class="font-medium ${isAuthor ? 'text-accent' : 'text-gray-400'}">${post.authorUsername || '匿名用户'} ${isAuthor ? '(您)' : ''}</span>
                            <span>${date.toLocaleString()}</span>
                        </div>
                    `;
                    postListContainer.appendChild(postItem);
                });
            }, (error) => {
                console.error("Error fetching posts: ", error);
                showMessage(`获取回复失败: ${error.message}`, true);
            });

            return container;
        }

        async function getTopicDocDetail(topicId, topicDetailEl) {
            try {
                const docSnap = await getDoc(getTopicDocRef(topicId));
                if (docSnap.exists()) {
                    const topic = docSnap.data();
                    const date = topic.createdAt && topic.createdAt.toDate ? topic.createdAt.toDate() : '未知日期';

                    topicDetailEl.innerHTML = `
                        <h1 class="text-3xl font-extrabold text-white">${topic.title}</h1>
                        <p class="text-gray-400 mt-4 text-lg leading-relaxed">${topic.content}</p>
                        ${renderMedia(topic)} <!-- 渲染详情页的媒体 -->
                        <div class="mt-4 text-sm text-gray-500 flex justify-between border-t border-gray-700 pt-2">
                            <span>发布者: <span class="text-accent font-semibold">${topic.authorUsername || '匿名用户'}</span></span>
                            <span>发布日期: ${date.toLocaleDateString()}</span>
                        </div>
                    `;
                } else {
                    topicDetailEl.innerHTML = `<h1 class="text-2xl font-bold text-red-500">主题不存在或已被删除</h1>`;
                }
            } catch (error) {
                console.error("Error getting topic detail: ", error);
                topicDetailEl.innerHTML = `<h1 class="text-2xl font-bold text-red-500">加载主题详情失败</h1>`;
            }
        }

        function createNewPostForm(topicId) {
            const formContainer = document.createElement('div');
            formContainer.className = 'bg-gray-dark p-6 rounded-xl shadow-lg mt-8 border-t-2 border-accent';
            
            formContainer.innerHTML = `
                <h3 class="text-xl font-bold text-accent mb-4 border-b border-gray-700 pb-2">提交您的解答或回复</h3>
                <form id="new-post-form-${topicId}" class="space-y-4">
                    <div>
                        <textarea id="post-content-${topicId}" rows="4" required placeholder="输入您的解答内容..." class="mt-1 block w-full input-dark resize-none"></textarea>
                    </div>
                    <button type="submit" id="submit-post-btn-${topicId}" class="w-full btn-neon mt-4">
                        <span class="no-skew block">提交解答/回复</span>
                    </button>
                </form>
            `;

            formContainer.querySelector(`#new-post-form-${topicId}`).onsubmit = async (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.isRegistered) return showRegistrationModal();

                const contentEl = formContainer.querySelector(`#post-content-${topicId}`);
                const content = contentEl.value.trim();
                const submitBtn = formContainer.querySelector(`#submit-post-btn-${topicId}`);

                if (!content) return showMessage('回复内容不能为空', true);
                
                submitBtn.disabled = true;
                submitBtn.querySelector('span').textContent = '提交中...';

                try {
                    const topicRef = getTopicDocRef(topicId);

                    // 1. 添加帖子到子集合
                    await addDoc(getPostsCollectionRef(topicId), {
                        content,
                        authorId: userId,
                        authorUsername: userProfile.username,
                        createdAt: serverTimestamp(),
                    });
                    
                    contentEl.value = ''; // 清空输入框
                    showMessage('回复发表成功！');
                    
                    // 2. 更新主题的最新活动时间和回复计数 (实现置顶和计数功能)
                    await updateDoc(topicRef, {
                         lastRepliedAt: serverTimestamp(),
                         replyCount: increment(1)
                    });
                    
                    // 3. 奖励经验值
                    const xpGained = 20 + Math.ceil(content.length / 10); // 基础20XP + 文本奖励
                    await grantXP(xpGained);

                } catch (error) {
                    console.error("Error adding post: ", error);
                    showMessage(`发表回复失败: ${error.message}`, true);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.querySelector('span').textContent = '提交解答/回复';
                }
            };

            return formContainer;
        }

        // --- Firebase 初始化和认证 ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 确保用户已认证
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                        } catch(e) {
                            console.error("Authentication fallback failed:", e);
                            userId = 'anonymous-fallback-' + (crypto.randomUUID ? crypto.randomUUID() : 'id');
                        }
                    } else {
                        userId = user.uid;
                    }
                    
                    isAuthReady = true;
                    
                    // 启动档案监听
                    setupProfileListener();

                    // 隐藏加载状态，显示应用
                    loadingEl.classList.add('hidden');
                    // 第一次渲染应用（默认为列表视图）
                    renderApp();
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingEl.innerHTML = `<p class="text-red-500">应用初始化失败: ${error.message}</p>`;
            }
        }
        
        window.onload = initializeFirebase;

        // 绑定平滑滚动
        document.addEventListener('DOMContentLoaded', () => {
            const smoothScrollLinks = document.querySelectorAll('a[href^="#"]');
            smoothScrollLinks.forEach(link => {
                if (link.getAttribute('href') !== '#') { 
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    });
                }
            });
        });

        // --- 导航和路由 ---

        window.navigate = function(viewName, topicId = null) {
            // 确保未注册用户不能进入 discussion 视图
            if (viewName === 'discussion' && (!userProfile || !userProfile.isRegistered)) {
                showRegistrationModal();
                return;
            }
            currentView = { name: viewName, topicId: topicId };
            renderApp();
            // 确保平滑滚动到讨论区
            document.getElementById('topics-list-section').scrollIntoView({ behavior: 'smooth' });
        }

        function renderApp() {
            if (!isAuthReady) return;

            appContainerEl.innerHTML = ''; // 清空容器
            
            if (currentView.name === 'list') {
                appContainerEl.appendChild(renderTopicList());
            } else if (currentView.name === 'discussion' && currentView.topicId) {
                appContainerEl.appendChild(renderDiscussion(currentView.topicId));
            }
        }
    </script>
</body>
</html>
```
